#An aid to de-obfuscating PHP malware

Lots of malware that afflicts WordPress, Joomla and other PHP-based
web sites is written in PHP. PHP is an interpreted language, so the
attackers must distribute their malware as source code. Much of the PHP
malware is obfuscated.  This (PHP) program does some limited de-obfuscation
to aid human understanding of the malware.

My gues is that the attackers obfuscate their PHP code for two reasons:

1. To evade simple signature or checksum based malware detection.
2. To attempt to keep website owners from understanding what the malware does.

I base guess no. 1 on the fact that obfuscation methods change rapidly, sometimes
only getting used for a single installation of malware.

I make guess no. 2 because the obfuscation is often just a "visual confusion"
thing, rather than any kind of encryption. Having `assert()` evaluate a single, very
long line of PHP isn't going to fool any algorithm, but the human eye might glide
right past it.

## Features

* Replaces strings obfuscated by Base64 (encoding and decoding), Rot13, URL-encoded, reversed
  and some forms of compression.
* It can de-obfuscate strings that are created by composing encoding, decoding, compression and
  other manipulations.
* It can replace function names that are obfuscated by indirection (i.e. `$function($arg1, $arg2...);`),
  or by tricky use of `$_GLOBAL`
* It replaces arguments of functions of special interest (`eval()`, `fopen()`, `preg_replace()`, etc) with de-obfuscated, or otherwise statically determined values.
* It aggregates concatenated strings, or concatenated mixes of strings and obscuring function calls.

## Installing

Use `composer` to retrieve the latest `PHP-Parser` code:
    composer install

After that, everything should be in place.

## Usage

Basic usage involves a file full of obfuscated PHP, and stdout:

    /wherever/reerse-php-malware/revphp  obfuscated.php > pretty.php

Command line flag `-C` causes it to leave comments in the ouput code. Ordinarily it deletes comments.

Should you find a function in some malware that deserves to have its arguments decoded, you can add that via a `-f` flag. For instance, `fwrite()` calls don't have their arguments de-obfuscated by default. To get `revphp` to do that:

    /wherever/reverse-php-malware/revphp -f fwrite obfuscated.php > cleanedup.php
    

    /wherever/reverse-php-malware/revphp -r something obfuscated.php > cleanedup.php

Very rarely, a malware author will put in a unique obfuscating function that's not merely a composition of `base64_encode()`,
`gzinflate()` and `rot13()`. In that case, you can edit out the obfuscating function into its own file. `revephp` can
read, evaluate, and use that special function during deobfuscation:

    /wherever/reverse-php-malware/revphp -D decoding_function.php obfuscated.php > cleanedup.php

## Design

`revphp` is written in PHP, and de-obfuscates PHP, in a kind of philosophical short-circuit.

`revphp` uses [PHP-Parser](https://github.com/nikic/PHP-Parser) to create a parse tree from
a source file, then traverses the parse tree. It keeps a global symbol table, and local
symbol tables, which are created and destroyed on parse-tree-function entrance and exit.

During the traverse of the parse tree, it keeps track of assignments to variables. Any value it can
de-obfuscate by `base64_decode()`, `urldecode()`, `strrev()`, `gzinflate()` and `gzuncompress()`, it will
associate with variable's name in the symbol table. It substitutes de-obfuscated values for obfuscated in the parse tree.

When it reaches a function call in the parse tree, it tries to de-obfuscate any indirect function names (like `$fn()`), substituting
de-obfuscated for obfuscated function name in the parse tree. If it happens upon an instance of a select list of functions, it examines any arguments and tries to substitute de-obfuscated arguments for obfuscated arguments in the parse tree.

Keeping a global and local symbol table allows `revphp` to de-obfuscate constructions like this:

    $slskdiekdo = 'base64_decode';
    ...
    $v = $_GLOBALS['slskdiekdo']('ZXZhbA==')(... nefarious PHP code in a string ...);

After it has completely traversed the parse tree, `revphp` uses a `PHP-Parser` built-in pretty-printer to present
the user with a (possibly de-obfuscated) source translation.

The design of `PHP-Parser` caused me to create `class RevPHPNodeVisitor extends PhpParser\NodeVisitorAbstract` which
contains almost all of the above functionality.

